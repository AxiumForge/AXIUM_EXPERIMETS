# TODO

## AxObjectClass Refaktorering (v0.1) - CRITICAL ðŸ”´

**Status:** Planlagt - ikke startet

**Problem:**
NuvÃ¦rende klassestruktur matcher IKKE AxObjectClass standard fra docs/AxObjectClassDefvo_1.md

**NuvÃ¦rende struktur (FORKERT):**
```haxe
class Box {
    public static var color = ...;
    public static inline function distance(p:Vector):Float { ... }
}
class BoxShader extends BaseRaymarchShader {
    static var SRC = { function map(p:Vec3):Vec4 { ... } };
}
```

**Korrekt struktur (AxObjectClass v0.1):**
```haxe
class Box implements AxObjectClass {
    public function new() {}
    public function shader():hxsl.Shader { ... }
    public function object():PdfObject { ... }
}
```

---

### Fase 0: Foundation (Forberedelse)

- [ ] **0.1** Opret `AxObjectClass.hx` interface
  ```haxe
  interface AxObjectClass {
      public function shader():hxsl.Shader;
      public function object():PdfObject;
  }
  ```

- [ ] **0.2** Opret `PdfObject.hx` typedef
  ```haxe
  typedef PdfObject = {
      name: String,
      sdf: { kind: String, params: Dynamic },
      transform: { position: {x:Float,y:Float,z:Float}, ... },
      material: { color: {r:Float,g:Float,b:Float,a:Float}, ... }
  }
  ```

- [ ] **0.3** Beslut shader return type strategi
  - Option A: ReturnÃ©r BaseRaymarchShader instance
  - Option B: ReturnÃ©r custom shader per shape
  - Option C: ReturnÃ©r shader data som shaderen compiles fra

---

### Fase 1: Pilot - Konverter 1 Shape (Box)

- [ ] **1.1** Backup nuvÃ¦rende Box.hx til Box.hx.old

- [ ] **1.2** Konverter Box til AxObjectClass
  - [ ] Fjern static color og distance()
  - [ ] Add implements AxObjectClass
  - [ ] Add new() constructor
  - [ ] Add shader() metode (integrer BoxShader funktionalitet)
  - [ ] Add object() metode (returnÃ©r PdfObject med box data)

- [ ] **1.3** Opdater ShapeCatalog til at hÃ¥ndtere AxObjectClass
  - [ ] Ã†ndr createShaderForShape() til at instantiere Box og kalde shader()
  - [ ] Test at Box loader og renderer korrekt

- [ ] **1.4** Test pilot implementation
  - [ ] Byg projekt
  - [ ] KÃ¸r med --sc --box
  - [ ] VerificÃ©r at Box renderer identisk med fÃ¸r

---

### Fase 2: Konverter Primitives (9 shapes)

- [ ] **2.1** Capsule â†’ AxObjectClass
- [ ] **2.2** Cone â†’ AxObjectClass
- [ ] **2.3** Cylinder â†’ AxObjectClass
- [ ] **2.4** Ellipsoid â†’ AxObjectClass
- [ ] **2.5** Plane â†’ AxObjectClass
- [ ] **2.6** Pyramid â†’ AxObjectClass
- [ ] **2.7** Sphere â†’ AxObjectClass
- [ ] **2.8** Torus â†’ AxObjectClass
- [ ] **2.9** Test alle 9 primitives renderer korrekt

---

### Fase 3: Konverter 2D Primitives (5 shapes)

- [ ] **3.1** Box2D â†’ AxObjectClass
- [ ] **3.2** Circle â†’ AxObjectClass
- [ ] **3.3** Heart â†’ AxObjectClass
- [ ] **3.4** RoundedBox2D â†’ AxObjectClass
- [ ] **3.5** Star â†’ AxObjectClass
- [ ] **3.6** Test alle 5 2D primitives renderer korrekt

---

### Fase 4: Konverter Derivates (6 shapes)

- [ ] **4.1** HalfCapsule â†’ AxObjectClass
- [ ] **4.2** HoledPlane â†’ AxObjectClass
- [ ] **4.3** HollowBox â†’ AxObjectClass
- [ ] **4.4** HollowSphere â†’ AxObjectClass
- [ ] **4.5** QuarterTorus â†’ AxObjectClass
- [ ] **4.6** ShellCylinder â†’ AxObjectClass
- [ ] **4.7** Test alle 6 derivates renderer korrekt

---

### Fase 5: Konverter 2D Organics (7 shapes)

- [ ] **5.1** FlowerPetalRing â†’ AxObjectClass
- [ ] **5.2** LeafPair â†’ AxObjectClass
- [ ] **5.3** LeafSpiral â†’ AxObjectClass
- [ ] **5.4** LotusFringe â†’ AxObjectClass
- [ ] **5.5** OrnateKnot â†’ AxObjectClass
- [ ] **5.6** SpiralVine â†’ AxObjectClass
- [ ] **5.7** VineCurl â†’ AxObjectClass
- [ ] **5.8** Test alle 7 2D organics renderer korrekt

---

### Fase 6: Konverter 3D Organics (12 shapes)

- [ ] **6.1** BlobbyCluster â†’ AxObjectClass
- [ ] **6.2** BubbleCrown â†’ AxObjectClass
- [ ] **6.3** BulbTreeCrown â†’ AxObjectClass
- [ ] **6.4** DripCone â†’ AxObjectClass
- [ ] **6.5** JellyDonut â†’ AxObjectClass
- [ ] **6.6** KnotTube â†’ AxObjectClass
- [ ] **6.7** MeltedBox â†’ AxObjectClass
- [ ] **6.8** PuffyCross â†’ AxObjectClass
- [ ] **6.9** RibbonTwist â†’ AxObjectClass
- [ ] **6.10** SoftSphereWrap â†’ AxObjectClass
- [ ] **6.11** UndulatingPlane â†’ AxObjectClass
- [ ] **6.12** WavyCapsule â†’ AxObjectClass
- [ ] **6.13** Test alle 12 3D organics renderer korrekt

---

### Fase 7: Cleanup & Documentation

- [ ] **7.1** Fjern alle .hx.old backup filer
- [ ] **7.2** Fjern BaseRaymarchShader hvis ikke lÃ¦ngere nÃ¸dvendig
- [ ] **7.3** Opdater Shapes.hx barrel file
- [ ] **7.4** Opdater ShapeCatalog.hx documentation
- [ ] **7.5** Opdater README med AxObjectClass pattern
- [ ] **7.6** Opdater CHANGELOG med v0.1 refaktorering
- [ ] **7.7** Test screenshot af alle 39 shapes: `--sc --<all shapes>`
- [ ] **7.8** Commit: "Refactor all 39 shapes to AxObjectClass v0.1 standard"

---

### Fase 8: Future - Ax Libraries

- [ ] **8.1** Design AxRaymarchLib (fÃ¦lles raymarching algoritmer)
- [ ] **8.2** Design AxMaterialLib (material evaluation)
- [ ] **8.3** Design AxAlphaLib (alpha helpers)
- [ ] **8.4** Design AxTexLib (procedural textures)
- [ ] **8.5** Opdater shaderen til at bruge Ax libraries

---

### Estimat

- **Total shapes:** 39
- **Phases:** 0-7 (8 er future work)
- **Critical path:** Fase 0 â†’ Fase 1 (pilot) â†’ beslut om fortsÃ¦t
- **Risk:** HÃ¸j - Ã¦ndrer fundamental arkitektur
- **Recommendation:** Lav Fase 0 + Fase 1 fÃ¸rst, test grundigt, beslut derefter

---

# TODO

## Alpha Transparency for SDF Shapes (2025-12-03)

**Status:** Midlertidig workaround implementeret for Box shader

**Problem:**
- Rigtig alpha blending (gennemsigtige SDF objekter) virker ikke i Heaps ScreenShader setup
- NÃ¥r `output.color = vec4(col, alpha)` med alpha < 1.0, bliver objekter ikke gennemsigtige
- I stedet pÃ¥virkes farve intensitet/genskin

**Hvad vi har prÃ¸vet:**
1. âœ… TilfÃ¸jet `alphaControl` parameter til BaseRaymarchShader
2. âœ… Enabled alpha blending: `fx.pass.setBlendMode(Alpha)` i Main.hx
3. âœ… Override fragment() i Box shader til at output alpha kanal
4. âš ï¸ Resultat: Alpha kanal virker ikke - farve/intensitet Ã¦ndres i stedet

**NuvÃ¦rende workaround (Box.hx:45-59):**
- Bruger `mix(background, shaded, alpha)` til at blande objekt mod baggrund
- Outputter fast `alpha = 1.0` for at undgÃ¥ dimming
- Dette simulerer transparency men er ikke rigtig alpha blending

**Konklusion:**
- Samme problem som LayeredScene (se nedenfor)
- ScreenShader + ScreenFx rendering pipeline understÃ¸tter ikke rigtig alpha blending
- Mulige Ã¥rsager: texture format, render target setup, eller Heaps limitation

**NÃ¦ste skridt:**
- AcceptÃ©r limitation og brug mix() workaround for shapes der skal have "alpha" kontrol
- Eller undersÃ¸g dybere i Heaps rendering pipeline for rigtig alpha blending
- DokumentÃ©r workaround pattern for andre shapes

---

## LayeredScene Transparency Issue

**Problem:**
LayeredScene skal vise 2D SDF patterns (rÃ¸d firkant, juletrÃ¦, stakit) pÃ¥ 3D bokse, hvor bokse-omrÃ¥der UDEN patterns skal vÃ¦re gennemsigtige/usynlige.

**Hvad vi har prÃ¸vet (ingen virker):**
1. âŒ Conditional distance field - kun inkludere bokse hvor patterns er
   - Resultat: Patterns blev ogsÃ¥ usynlige

2. âŒ SÃ¦tte farve til (0,0,0) for omrÃ¥der uden patterns
   - Resultat: Sort, ikke gennemsigtig

3. âŒ Bruge GLSL `discard` keyword i fragment shader
   - Resultat: Stadig sort

4. âŒ Implementere alpha kanal (output.color = vec4(col, alpha))
   - Resultat: Ingen forskel

**Konklusion:**
Problemet er sandsynligvis i Heaps/OpenGL rendering setup:
- GL_BLEND skal mÃ¥ske enables
- ScreenShader understÃ¸tter mÃ¥ske ikke alpha blending
- BaseRaymarchShader er ikke sat op til transparency

**NuvÃ¦rende tilstand:**
- LayeredScene eksisterer og kompilerer
- Viser 2D patterns korrekt
- Men bokse-omrÃ¥der uden patterns viser sort i stedet for gennemsigtig
- NuvÃ¦rende kode bruger alpha kanal approach

**NÃ¦ste skridt:**
- UndersÃ¸g Heaps ScreenShader alpha blending setup
- Evt. modificer BaseRaymarchShader til at enable blending
- Eller acceptÃ©r limitation og brug en alternativ visuel tilgang
