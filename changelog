# AXIUM_EXPERIMENTS Changelog

## 2025-12-02 - Modular SDF Shape Architecture (COMPLETED)

### Added
- **Modular shape organization** - Each shape now has its own module with data class and shader class
  - ✅ Implemented for 20/39 shapes: all primitives (9), 2D primitives (5), derivates (6)
  - Remaining 19 shapes pending conversion (2D Organics + 3D Organic)
- **BaseRaymarchShader** - Base shader class for all SDF shapes with common raymarching/lighting
  - Handles raymarching loop, normal calculation, lighting (diffuse, rim, ambient)
  - Child shaders only need to implement `map(p:Vec3):Vec4` function
- **Dynamic shader swapping** - Main.hx now creates appropriate shader instance when user selects shape
  - `createShaderForShape(name:String)` function maps shape names to shader classes
  - `selectShape(index:Int)` creates new shader and updates ScreenFx
- **Documentation**:
  - `docs/haxe-heaps-patterns.md` - RAG document with Haxe/Heaps best practices and references
  - `obj/README.md` - Updated with module pattern documentation and usage examples
- **Screenshot functionality** - F12/P keys and --sc command line flag for automated screenshots
- **Dynamic shape-based screenshot system** - Auto-discovery system for taking screenshots of specific shapes
  - Parse command line args for shape flags (e.g., `--torus --box2d`)
  - Automatically generates flags for all shapes - not hardcoded, adapts to new shapes
  - Sequential screenshot capture when `--sc` combined with shape flags
  - Named output files (Torus.png, Box2D.png) instead of timestamps
  - 3-frame delay between shader swaps for proper rendering

### Added
- **Frame sequence screenshots** - Capture animation cycles of individual shapes
  - New `--seq` or `--sc-seq` flag to enable frame sequence mode
  - Captures 20 frames of a shape's animation cycle
  - Can specify shape: `--seq --wavycapsule` or uses current shape
  - Saves to `/sc/sequence-01/` directory with `frame_0001.png` to `frame_0020.png` naming
  - Uses Screenshot.hx's `sequenceDir()` and `saveSequenceFrame()` methods
  - Perfect for creating GIF animations or studying shape behavior
- **Shapes.hx barrel file** - Centralized import for all 39 shape classes using Haxe barrel pattern
  - Single `import Shapes;` replaces 39 individual shape imports
  - Makes all shape classes available to Type.resolveClass() for dynamic shader instantiation
  - Used in Main.hx, ShapePanel.hx, and ShapeCatalog.hx for consistency
  - Follows pattern from docs/haxe_barrel.md

### Refactored
- **Main.hx modular architecture** - Extracted UI, shape management, and utilities into separate modules:
  - **ShapePanel.hx** - All UI logic (panel, scrolling, shape selection, keyboard/mouse events)
  - **ShapeCatalog.hx** - Shape registry and shader factory (defaultCategories, shapeNames, createShaderForShape)
  - **Screenshot.hx** - Screenshot utilities with sequence support (saveWithName, saveTexture, saveSequenceFrame)
  - **Main.hx** - Now orchestrates engine, rendering, camera, and screenshot flow (~360 lines, down from 500+)
- **Screenshot.hx integration** - Main.hx now uses Screenshot utility methods instead of inline pixel capture code
  - Added `saveWithName()` method for custom filename screenshots (e.g., "Torus.png", "Box2D.png")
  - Removed inline pixel capture, PNG conversion, and file saving code
  - Cleaner separation of concerns between rendering and file I/O

### Changed
- **Shape file structure** - From nested classes to proper module pattern with two top-level classes:
  ```haxe
  // Before: Single class with data only
  class Box {
      public static var color = ...;
      public static function distance(p:Vector):Float { }
  }

  // After: Module with data class + shader class
  class Box {
      public static var color = ...;
      public static function distance(p:Vector):Float { }
  }
  class BoxShader extends BaseRaymarchShader {
      static var SRC = {
          function map(p:Vec3):Vec4 { }
      }
  }
  ```
- **Package structure** - Fixed package names to match folder structure and Haxe naming conventions:
  - `obj.primitives` (was `obj`)
  - `obj.primitives2d` (renamed folder from `2dprimitives` to match package)
  - `obj.derivates`
  - `obj.organics2d` (was `obj._2DOrganics`, renamed to Haxe-compliant name)
  - `obj.organics3d` (was `obj._3dOrganic`, renamed to Haxe-compliant name)
- **Main.hx** - Refactored to use dynamic shader swapping instead of monolithic SDFObjectFarmShader

### Fixed
- **Haxe module pattern** - Removed incorrect nested class structure that doesn't exist in Haxe
- **Duplicate parameter declarations** - Removed `@param var time : Float;` from all child shaders (inherited from BaseRaymarchShader)
- **Inline variable errors** - Removed `inline` keyword from static variables with `new Vector()` initializers (only kept on functions)
- **Package/folder mismatch** - Renamed `obj/2dprimitives/` to `obj/primitives2d/` to match Haxe package naming conventions
- **Reserved keyword issue** - Renamed `package` field to `pkg` in shapeCategories anonymous structure (package is reserved keyword in Haxe)
- **2D SDF rendering bug** - Fixed all 2D shapes (primitives and organics) rendering incorrectly
  - Problem: Used `rotateXYZ()` which rotates in all 3 dimensions, deforming 2D shapes to 3D
  - Solution: Added `rotateY()` helper function to BaseRaymarchShader for Y-axis rotation only
  - Updated all 12 2D shapes (5 primitives + 7 organics) to use `rotateY()` instead of `rotateXYZ()`
  - Renamed organic folders to Haxe-compliant names: `obj._2DOrganics` → `obj.organics2d`, `obj._3dOrganic` → `obj.organics3d`
  - Fixed variable name conflict in RibbonTwist.hx (`length` variable shadowing built-in function)
  - Fixed inline errors in all organic shapes (arrays and Vector instances cannot be inline)

### Testing
- ✅ Compilation successful after fixing all module pattern issues
- ✅ Screenshot test (`--sc` flag) confirms BoxShader renders correctly
- ✅ UI panel displays all 20 converted shapes with correct categorization
- ✅ Shape selection and shader swapping functional
- ✅ Multi-shape screenshot sequence tested (`--sc --torus --box2d`)
- ✅ 4-shape screenshot sequence tested (`--sc --sphere --capsule --pyramid --heart`)
- ✅ Named screenshot files generated correctly (Torus.png, Box2D.png, etc.)
- ✅ 2D shapes rendering correctly verified (Box2D, Circle, Heart, LeafPair all render as proper 2D shapes)
- ✅ All 39 shapes compile and load successfully with new package structure
- ✅ Refactored Main.hx builds and runs successfully
- ✅ ShapePanel.hx UI integration functional (panel, scrolling, selection)
- ✅ Screenshot.hx integration tested (`--sc --sphere --torus` generates correct files with Screenshot.saveWithName())
- ✅ Frame sequence tested (`--seq --wavycapsule` captures 20 frames to sc/sequence-01/)
- ✅ Shapes.hx barrel import tested (all shapes load correctly with single import)

### Technical Details

**Architecture Pattern:**
- Follows Haxe module conventions (primary type + sub-types in same file)
- Follows HXSL philosophy (small focused shaders, not Uber Shader)
- Separation of concerns (CPU data/logic vs GPU shader code)
- Easy maintenance (everything for one shape in one file)
- Dynamic shader instantiation at runtime (no Uber Shader with switch statements)

**Implemented Shapes (20/39):**

*Primitives (9):*
- Box, Sphere, Capsule, Cone, Cylinder, Ellipsoid, Plane, Pyramid, Torus

*2D Primitives (5):*
- Box2D, Circle, Heart, RoundedBox2D, Star

*Derivates (6):*
- HalfCapsule, HoledPlane, HollowBox, HollowSphere, QuarterTorus, ShellCylinder

**Pending Conversion (19/39):**

*2D Organics (7):*
- FlowerPetalRing, LeafPair, LeafSpiral, LotusFringe, OrnateKnot, SpiralVine, VineCurl

*3D Organic (12):*
- BlobbyCluster, BubbleCrown, BulbTreeCrown, DripCone, JellyDonut, KnotTube, MeltedBox, PuffyCross, RibbonTwist, SoftSphereWrap, UndulatingPlane, WavyCapsule

### References
- [Haxe Module Sub-Types](https://haxe.org/manual/type-system-module-sub-types.html)
- [HXSL Documentation](https://heaps.io/documentation/hxsl.html)
- [HXSL Wiki](https://github.com/HeapsIO/heaps/wiki/HXSL)

---

## Previous Changes

(Add previous changelog entries here)
